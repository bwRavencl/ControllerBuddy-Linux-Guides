# EF 2000 V2.0 with ControllerBuddy on Linux

## ðŸ“– Description

This guide describes the setup of [EF 2000 V2.0](https://en.wikipedia.org/wiki/EF2000_(video_game)) for use with [ControllerBuddy](https://controllerbuddy.org/) on Linux via the [DOSBox Staging](https://www.dosbox-staging.org) emulator.

What you get with this setup:
- An installation of EF 2000 V2.0 that is nicely integrated into your Steam library.
- ControllerBuddy will start automatically when you start the game, load the correct profile, and exit after you exit the game.

## ðŸ§© Prerequisites

- [Steam](https://steampowered.com/) (distribution package)
- [DOSBox Staging Flatpak](https://flathub.org/en/apps/io.github.dosbox-staging)
- [ControllerBuddy Flatpak](https://github.com/bwRavencl/ControllerBuddy-Flatpak)
- EF2000 V2.0 CD or CD-Image

## ðŸªœ Steps

1. Follow the [*Installing EF2000 V2.0 without PCem* section](https://www.tales-from-darkenedroom.com/post/ef2000-updated-part-2-installation#:~:text=disk%2E-,Installing,install,-%2E) of DarkenedRoom's EF2000 guide to obtain an installation of EF2000 V2.0 for 3DFX.
2. Create a folder to hold your EF2000 V2.0 for 3DFX installation, along with a custom DOSBox config file and a launch script.
    ```sh
    mkdir "$HOME/EF2000_V2.0"
    ```
3. Copy the `EF2000 V2.0 for 3DFX` installation folder from step 1 in to the newly created folder from step 2, so that it has the following path: `$HOME/EF2000_V2.0/EF2000 V2.0 for 3DFX`
4. Configure EF2000 V2.0 to work with the `EF2000_V2.0.json` profile from [ControllerBuddy-Profiles](https://github.com/bwRavencl/ControllerBuddy-Profiles):
    ```sh
    controller_buddy_profiles_dir=$(realpath -s "$(flatpak info -l de.bwravencl.ControllerBuddy)/../active/files/share/ControllerBuddy-Profiles") &&
    cp "$controller_buddy_profiles_dir/configs/EF2000_V2.0/EF2000.CFG" "$HOME/EF2000_V2.0/EF2000 V2.0 for 3DFX/"
    ```
4. Create the DOSBox config file.
    ```sh
    cat << EOF > "$HOME/EF2000_V2.0/dosbox_ef2000.conf"
    [sdl]
    fullscreen = true

    [dosbox]
    memsize = 64

    [render]
    glshader = nearest

    [cpu]
    core = dynamic
    cycles = 200000

    [joystick]
    joysticktype = 4axis
    timed = false
    deadzone = 0

    [dos]
    keyboardlayout = us

    [ipx]
    ipx = true

    [autoexec]
    @echo off
    mount c .
    imgmount d EF2000V20.cue -t iso -fs iso
    c:
    cd EF2000~1.0FO
    cls
    EF2000.EXE
    exit
    ```
5. Create the launch script.
    ```sh
    cat << EOF > "$HOME/EF2000_V2.0/EF2000_V2.0.sh"
    #!/bin/bash

    CB_PROFILE=EF2000_V2.0.json
    DOSBOX_CONF=dosbox_ef2000_v2.conf

    cd "$(cd -- "$(dirname -- "$0")" &> /dev/null && pwd)" || exit

    flatpak run de.bwravencl.ControllerBuddy -autostart local -profile "/app/share/ControllerBuddy-Profiles/$CB_PROFILE" -tray &

    WAIT_TIMEOUT=10
    CB_DEVICE_NAME="ControllerBuddy Joystick"

    for (( i=1; i<=WAIT_TIMEOUT; i++ )); do
        CB_JOYSTICK_DEVICE=$(awk -v RS='' "/Name=\"$CB_DEVICE_NAME\"/{match(\$0, /js[0-9]+/); print substr(\$0, RSTART, RLENGTH); exit}" /proc/bus/input/devices)

        if [ -n "$CB_JOYSTICK_DEVICE" ]; then
            break
        fi

        sleep 1
    done

    function quit_cb {
        killall -q ControllerBuddy
    }

    if [ -z "$CB_JOYSTICK_DEVICE" ]; then
        zenity --error --text="Launch aborted because $CB_DEVICE_NAME wasn't ready within $WAIT_TIMEOUT seconds.\n\nCheck if your controller is connected." --width 500
        quit_cb
        exit 1
    fi

    SDL_JOYSTICK_DEVICE="/dev/input/$CB_JOYSTICK_DEVICE" \
    SDL_MOUSE_RELATIVE_SPEED_SCALE=0.3 \
    flatpak run io.github.dosbox-staging -conf "$DOSBOX_CONF"

    quit_cb
    ```
6. Add the launch script (`$HOME/EF2000_V2.0/EF2000_V2.0.sh`) as a Non-Steam game to your Steam library.
7. Rename the **EF2000_V2.0.sh** Steam shortcut to **EF2000 V2.0 (ControllerBuddy)**.

## ðŸŽ® Steam Deck Specifics

### Configure Touchpads

There is a special ControllerBuddy Steam Input controller layout available which configures the Steam Deck's touchpads to act as a mouse replacement.

| Control              | Function           |
|----------------------|--------------------|
| Right Touchpad       | Move mouse cursor  |
| Right Touchpad Click | Left mouse button  |
| Left Touchpad Click  | Right mouse button |
| Left Touchpad Y-Axis | Scroll up/down     |

To use this the layout:
1. Open the following link in the Steam browser to obtain the controller layout: `steam://controllerconfig/25189661165/3605812061`
2. Apply the layout to both **Jane's Fighters Anthology** shortcuts to your Steam library.
